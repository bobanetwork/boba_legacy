#adapted from https://raw.githubusercontent.com/ethereum-optimism/optimism/develop/.circleci/config.yml
version: 2.1

jobs:
  integration-tests:
    machine:
      image: ubuntu-2004:202111-02
      docker_layer_caching: true
    environment:
      DOCKER_BUILDKIT: 1
    parallelism: 2
    steps:
      - checkout
      - run:
          name: Bring up the stack
          command: |
            ./scripts/build-ci.sh
            BUILD=1 DAEMON=1 ./up_local.sh
          working_directory: ops
      - run:
          name: Start background logging
          working_directory: ops
          background: true
          command: docker-compose -f docker-compose.yml logs --follow
      - run:
          name: Wait for sequencer
          command: bash scripts/wait-for-sequencer.sh
          working_directory: ops
      - run:
          name: Run integration tests
          command: |
            circleci tests glob "/opt/optimisim/integration-tests/test/basic*.spec.ts" | circleci tests split --split-by=timings --time-default=10s | tee splits.txt
            docker-compose run integration_tests $(cat splits.txt)
          working_directory: ops
      - run:
          name: Rewrite test name for next run
          command:
            sed -i 's/\/opt\/optimism/../g' /home/circle/result/output.xml
      - store_test_results:
          path: /home/circleci/result/
      - store_artifacts:
          path: /home/circleci/result/

workflows:
  main:
    jobs:
      - integration-tests
